<!DOCTYPE html>
<html>
<head>
    <title>RunningTotal</title>

    <script type="text/javascript" src="/apps/2.0p5/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
            /**
             * @private
             * Plugin for grid drag and drop // hacked to change the responsiveness
             */
            Ext.define('Rally.ui.grid.plugin.DragDrop2', {
                requires: ['Rally.data.Ranker', 'Rally.ui.grid.dragdrop.DragZone', 'Rally.ui.grid.dragdrop.DropZone'],
                extend : 'Ext.grid.plugin.DragDrop',
                alias : 'plugin.rallydragdrop2',
            
                rankEnabledCls: 'rank-enabled',
            
                clientMetrics: [
                    {
                        event: 'drop',
                        defaultUserAction: 'artifact ranked by drag/drop'
                    },
                    {
                        method: '_onInitDrag',
                        defaultUserAction: 'artifact drag rank start'
                    }
                ],
            
                init: function(view) {
                    this.view = view;
                    this.view.mon(this.view.getStore(), 'load', this._onStoreLoad, this);
                    this.view.mon(this.view, 'drop', this._onDrop, this);
                    this.view.headerCt.mon(this.view.headerCt, 'columnshow', this._setupRankColumn, this);
                    this.callParent(arguments);
                },
            
                destroy: function() {
                    Ext.dd.ScrollManager.unregister(this.view.getEl());
                    this.callParent(arguments);
                },
            
                enable: function() {
                    this._showRankColumn();
                    this.callParent(arguments);
                },
            
                disable: function() {
                    this._hideRankColumn();
                    this.callParent(arguments);
                },
            
                onViewRender: function() {
                    this._setupViewScroll();
                    this._setupRankColumn();
                    this._enableDragDrop();
                },
            
                _setupViewScroll: function() {
                    var el = this.view.getEl();
            
                    el.ddScrollConfig = {
                        vthresh: 10,
                        hthresh: -1,
                        frequency: 100,
                        increment: 75
                    };
                    Ext.dd.ScrollManager.register(el);
                },
            
                _setupRankColumn: function() {
                    var rankCol = this._getRankColumn();
                    if (rankCol) {
                        var rankField = this._getRanker().rankField;
                        rankCol.getSortParam = function() {return rankField;};
                    }
                },
            
                _enableDragDrop: function() {
                    var _onBeforeDrag = Ext.bind(this._onBeforeDrag, this),
                        onBeforeDrag = function() {
                            if (this.callParent(arguments) === false || _onBeforeDrag.apply(this, arguments) === false) {
                                return false;
                            }
                        };
            
                    this.dragZone = new Rally.ui.grid.dragdrop.DragZone({
                        view: this.view,
                        ddGroup: this.dragGroup || this.ddGroup,
                        dragText: this.dragText,
                        onBeforeDrag: onBeforeDrag
                    });
            
                    this.dropZone = new Rally.ui.grid.dragdrop.DropZone({
                        view: this.view,
                        ddGroup: this.dropGroup || this.ddGroup
                    });
                },
            
                _getRankColumn: function() {
                    var rankCol = this.view.headerCt.items.getAt(0);
                    if (rankCol instanceof Rally.ui.grid.RankColumn) {
                        return rankCol;
                    }
                    return null;
                },
            
                _userDraggingRankCell: function(event) {
                    var rankCol = this._getRankColumn();
                    if (rankCol && event.getTarget('.' + rankCol.tdCls)) {
                        return true;
                    }
                    return false;
                },
            
                _setConstraints: function() {
                    var dragDrop = this.dragZone;
            
                    dragDrop.setInitPosition();
            
                    var el = this.view.getEl(),
                        gridCmp = Ext.ComponentQuery.query('#' + el.up('.rally-grid').id)[0],
                        headerEl = gridCmp.headerCt.getEl(),
                        xy = el.getXY(),
                        top = dragDrop.initPageY - xy[1],
                        padding = 3;
            
                    dragDrop.setXConstraint(0, 0);
                    dragDrop.setYConstraint(top, el.getHeight() - top - headerEl.getHeight() - padding);
                },
            
                _showRankColumn: function() {
                    if (!this.view.hasCls(this.rankEnabledCls)) {
                        this.view.addCls(this.rankEnabledCls);
                    }
                },
            
                _hideRankColumn: function() {
                    this.view.removeCls(this.rankEnabledCls);
                },
            
                _getRanker: function() {
                    if (!this.ranker) {
                        var store = this.view.getStore(),
                            config = {store: store};
            
                        if (store.model.elementName === 'Task') {
                            config.rankField = 'TaskIndex';
                            config.relativeRankPrefix = 'taskIndex';
                        }
                        this.ranker = Ext.create('Rally.data.Ranker', config);
                    }
            
                    return this.ranker;
                },
            
                _onBeforeDrag: function(dragData) {
                    if (!this._userDraggingRankCell(dragData.event)) {
                        return false;
                    }
            
                    this._onInitDrag();
                },
            
                _onInitDrag: function() {
                    if (this.dropZone) {
                        this.dropZone.onInitDrag(this.dragZone);
                    }
            
                    this._setConstraints();
                },
            
                _onStoreLoad: function() {
                    if (this._getRanker().isRankable()) {
                        this.enable();
                    } else {
                        this.disable();
                    }
                },
            
                _onDrop: function(rowEl, dropData, overModel, dropPosition, opts) {
                    var ranker = this._getRanker(),
                        rankConfig = {
                            recordToRank: dropData.records[0],
                            relativeRecord: overModel,
                            position: dropPosition,
                            saveOptions: {
                                callback: this._onRank,
                                scope: this
                            }
                        };
            
                    this.view.ownerCt.setLoading(true);
                    ranker.rankRelative(rankConfig);
                },
            
                _onRank: function(record, operation) {
                    this.view.ownerCt.setLoading(false);
                    this.view.publish(Rally.Message.objectUpdate, record, this.view);
                }
            });
            /*global console, Ext */
            var renderUSDate = function(value) {
                var display_value = "";
                if ( value ) {
                    display_value = Rally.util.DateTime.format( value, 'm/d/Y');
                }
                return display_value;
            };
            var renderFieldName = function(value) {
                var display_value = "";
                if ( value ) {
                    display_value = value._refObjectName;
                }
                return display_value;
            };
                
            Ext.define('CustomApp', {
                extend: 'Rally.app.App',
                field_to_sum: 'FeatureEstimate',
                columns: [
                    { xtype: 'rallyrankcolumn' },
                    { text: 'ID', dataIndex: 'FormattedID' },
                    { text: 'Name', dataIndex: 'Name', flex: 1 },
                    { text: 'Running Total', dataIndex: 'RunningTotal' },
                    { text: 'Feature Estimate', dataIndex: 'FeatureEstimate' },
                    { text: 'Planned Start', dataIndex: 'PlannedStartDate', renderer: renderUSDate },
                    { text: 'Planned End', dataIndex: 'PlannedEndDate', renderer: renderUSDate },
                    { text: 'State', dataIndex: 'State', renderer: renderFieldName },
                    { text: 'Owner', dataIndex: 'Owner', renderer: renderFieldName },
                    { text: 'Parent', dataIndex: 'Parent', renderer: renderFieldName }
                ],
                componentCls: 'app',
                items: [{ xtype: 'container', itemId: 'grid_box' }],
                launch: function() {
                	this._getPIModel();
                },
                _getPIModel: function() {
                	Rally.data.ModelFactory.getModel({
                		type: 'PortfolioItem/Feature',
                		success: function(userStoryModel) {
                			this.model = userStoryModel;
                			this._addPIGrid();
                		},
                		scope: this
                	});
                },
                _addPIGrid: function() {
                	if ( this.model ) {
                		this.pigrid = Ext.create( 'Rally.ui.grid.Grid', {
                			model: this.model,
                			height: 500,
                			/*enableRanking: true,*/
                			viewConfig: {
                				plugins: [
                					{ ptype: 'rallydragdrop2' }
                				]
                			},
            	    		columnCfgs: this.columns,
                            storeConfig: {
                                sorters: [ { property: 'Rank', direction: 'ASC' } ],
                                listeners: {
                                    datachanged: function( store, opts ) {
                                        console.log( "datachanged", store.getRecords() );
                                        var records = store.getRecords();
                                        var running_total = 0;
                                        for ( var i=0; i<records.length; i++ ) {
                                            var record = records[i];
                                            var value = record.data[this.field_to_sum] || 0;
                                            running_total += value;
                                            record.data.RunningTotal = running_total;
                                        }
                                    },
                                    scope: this
                                }
                            }
            
                		});
            	    	this.down('#grid_box').add(this.pigrid);
                	}
                }
            });

            Rally.launchApp('CustomApp', {
                name: 'RunningTotal'
            });
        });
    </script>

    <style type="text/css">
        .app {
             /* Add app styles here */
        }
    </style>
</head>
<body></body>
</html>
