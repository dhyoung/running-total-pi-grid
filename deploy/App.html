<!DOCTYPE html>
<html>
<head>
    <title>RunningTotal</title>

    <script type="text/javascript" src="/apps/2.0p5/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
            /**
             * Temporary hack to remove publishing message so that editing in-line 
             * doesn't refresh the whole app
             * 
             * AND to stick in pencil (the editing hover over only on editable fields)
             */
            
            /**
             * @private
             * Plugin for grid cell editing
             */
            Ext.define('Rally.ui.grid.plugin.CellEditing', {
                requires: ['Rally.ui.grid.OwnerEditor'],
                extend: 'Ext.grid.plugin.CellEditing',
                alias: 'plugin.rallycellediting',
            
                mixins: {
                    messageable: 'Rally.Messageable'
                },
            
                triggerEvent: 'triggeredit',
            
                //=============================
                // Private method override danger zone
                //
                onEnterKey: Ext.emptyFn,
            
                onEscKey: function() {
                    this.callParent(arguments);
            
                    //Need to return true to prevent underlying key map
                    //from stopping the escape key event in case other components need to handle it
                    return true;
                },
            
                //
                // End private method override danger zone
                //=============================
            
                /**
                 * @event recordupdatesuccess
                 * Publishes the global {@link Rally.Message#recordUpdateSuccess} message when a record
                 * is successfully updated via inline-editing
                 * @param {Object[]} records The updated records
                 */
                /**
                 * @event recordupdatefailure
                 * Publishes the global {@link Rally.Message#recordUpdateFailure} message when a record
                 * is unsuccessfully updated via inline-editing
                 */
            
                init: function() {
                    this.callParent(arguments);
            
                    this.grid.addEvents(
                            /**
                             * @event
                             * Fires after an inline edit occurs
                             * @param {Rally.ui.grid.Grid} this
                             * @param {Ext.grid.plugin.Editing} editor The editor object from Ext.grid.plugin.CellEditing#edit
                             * @param {Object} event The e object from Ext.grid.plugin.CellEditing#edit
                             */
                            'inlineEdit',
                            /**
                             * @event
                             * Fires when an inline edit has been saved
                             * @param {Rally.ui.grid.Grid} this
                             * @param {Ext.data.Model[]} records The records array from Ext.data.Operation#callback
                             * @param {Ext.data.Operation} operation See Ext.data.Operation#callback
                             * @param {Ext.data.Model} record The original record that was updated
                             * @param {Ext.grid.column.Column) The column that was updated
                             */
                            'inlineEditSaved'
                    );
                    
                    this.mon(this.grid, 'edit', this._saveInlineEdit, this);
                    this.mon(this.grid.getView(), 'uievent', this._onUiEvent, this);
                    this.mon(this.grid, 'beforeedit', this._onBeforeEdit, this);
                },
            
                getEditor: function(record, column) {
                    var editor = this.callParent(arguments);
                    editor.completeOnEnter = false;
                    return editor;
                },
            
                showEditor: function(ed, context, value) {
                    this._onPossibleGridHeightChange();
            
                    if (Ext.isFunction(ed.prepareEditor)) {
                        var superclassShowEditorFn = Ext.bind(this.superclass.showEditor, this, [ed, context, value]);
                        ed.prepareEditor(context, superclassShowEditorFn);
                    } else {
                        this.callParent(arguments);
                    }
            
                },
            
                onSpecialKey: function(editor, field, event) {
                    var keyCode = event.getKey(),
                        sm;
            
                    if (keyCode === event.ENTER && !editor.completeOnEnter) {
                        event.stopEvent();
                        this._preventExtFromDeferringOnBlur(field, editor);
            
                        sm = this.grid.getSelectionModel();
                        sm.onEditorEnter(this, field, event);
                    }
            
                    this.callParent(arguments);
                },
            
                cancelEdit: function() {
                    var isEditorActive = this.getActiveEditor();
                    this.callParent(arguments);
                    if (isEditorActive) {
                        this._onPossibleGridHeightChange();
                    }
                },
            
                _saveInlineEdit: function(editor, event) {
                    if (Ext.Object.getSize(event.record.getChanges()) > 0) {
                        var grid = this.grid,
                            record = this.context.record,
                            column = this.context.column;
            
                        grid.fireEvent('inlineEdit', this, editor, event);
            
                        event.record.save({
                            callback: function(records, operation) {
                                var success = operation.success;
                                if (success) {
            //                        this.publish(Rally.Message.objectUpdate, records, this);
            //                        this.publish(Rally.Message.recordUpdateSuccess, records);
                                } else {
                                    this.publish(Rally.Message.recordUpdateFailure);
                                }
            
                                if(this.grid){
                                    this.grid.fireEvent('inlineeditsaved', this, records, operation, record, column);
                                    this._onPossibleGridHeightChange();
                                    if(success){
                                        Ext.each(records, function(record) {
                                            this.grid.highlightRowForRecord(record);
                                        }, this);
                                    }
                                }
                            },
                            scope: this,
                            params: {
                                fetch: grid.getAllFetchFields()
                            }
                        });
                    }else{
                        this._onPossibleGridHeightChange();
                    }
                },
            
                _onPossibleGridHeightChange: function(){
                    this.grid.doLayout();
                },
            
                _isEditableCell: function( view, cellIndex ) {
                	var columns = view.getGridColumns();
                	var result = false;
                	if ( columns[cellIndex].editor ) {
                		result = true;
                	}
                	return result;
                },
                _onUiEvent: function(type, view, cell, rowIndex, cellIndex, e) {
                    var cellEl = Ext.fly(cell);
                    if (cellEl) {
                    	console.log(  );
                    	if (this._isEditableCell(view, cellIndex) ) {
            	            if (type === 'mouseover') {
            	                cellEl.addCls('rally-edit-cell-over');
            	            } else if (type === 'mouseout') {
            	                cellEl.removeCls('rally-edit-cell-over');
            	            }
                    	}
                    }
                },
            
                _onBeforeEdit: function(editor, object, eOpts) {
                    var cell = editor.grid.getView().getCell(object.record, object.column),
                        cellEl = Ext.fly(cell);
                    if (cellEl) {
                        cellEl.removeCls('rally-edit-cell-over');
                    }
                },
            
                _preventExtFromDeferringOnBlur: function (field, editor) {
                    // Ext defers the handling of the onBlur event by 10 milliseconds for fields
                    // inside of editors. This is breaking our own grid keyboard navigation when
                    // pressing enter to go to the next row. So we need to use the base onBlur
                    // method (because it is not deferred) just for our enter key handling. We
                    // put back the original ext onBlur handler once we are done.
                    var focusEl = field.getFocusEl(),
                        nonDeferredOnBlur = function() {
                            Ext.AbstractComponent.prototype.onBlur.call(field);
                            focusEl.on('blur', field.onBlur, field);
                        },
                        nonDeferredFieldBlur = function(x, event) {
                            editor.onFieldBlur.apply(editor, [field, event]);
                            editor.mon(field, {
                                blur: {
                                    fn: editor.onFieldBlur,
                                    delay: 1
                                },
                                scope: editor
                            });
                        };
            
                    // unregister the handlers that have delays and then register
                    // handlers that doesn't have the delay
                    focusEl.un('blur', field.onBlur, field);
                    this.mon(focusEl, 'blur', nonDeferredOnBlur, field, {single:true});
            
                    editor.mun(field, 'blur', editor.onFieldBlur, editor);
                    editor.mon(field, 'blur', nonDeferredFieldBlur, editor, {single: true});
                }
            });            /**
             * @private
             * Plugin for grid drag and drop // hacked to change the responsiveness
             */
            Ext.define('Rally.ui.grid.plugin.DragDrop2', {
                requires: ['Rally.data.Ranker', 'Rally.ui.grid.dragdrop.DragZone', 'Rally.ui.grid.dragdrop.DropZone'],
                extend : 'Ext.grid.plugin.DragDrop',
                alias : 'plugin.rallydragdrop2',
            
                rankEnabledCls: 'rank-enabled',
            
                clientMetrics: [
                    {
                        event: 'drop',
                        defaultUserAction: 'artifact ranked by drag/drop'
                    },
                    {
                        method: '_onInitDrag',
                        defaultUserAction: 'artifact drag rank start'
                    }
                ],
            
                init: function(view) {
                	window.console && console.log( "rdd2.init" );
                    this.view = view;
                    this.view.mon(this.view.getStore(), 'load', this._onStoreLoad, this);
                    this.view.mon(this.view, 'drop', this._onDrop, this);
                    this.view.headerCt.mon(this.view.headerCt, 'columnshow', this._setupRankColumn, this);
                    this.callParent(arguments);
                    this.enable();  // assuming we're starting ranked.  Data load isn't kicking this off!
                },
            
                destroy: function() {
                    Ext.dd.ScrollManager.unregister(this.view.getEl());
                    this.callParent(arguments);
                },
            
                enable: function() {
                    this._showRankColumn();
                    this.callParent(arguments);
                },
            
                disable: function() {
                    this._hideRankColumn();
                    this.callParent(arguments);
                },
            
                onViewRender: function() {
                    this._setupViewScroll();
                    this._setupRankColumn();
                    this._enableDragDrop();
                },
            
                _setupViewScroll: function() {
                    var el = this.view.getEl();
            
                    el.ddScrollConfig = {
                        vthresh: 10,
                        hthresh: -1,
                        frequency: 100,
                        increment: 75
                    };
                    Ext.dd.ScrollManager.register(el);
                },
            
                _setupRankColumn: function() {
                    var rankCol = this._getRankColumn();
                    if (rankCol) {
                        var rankField = this._getRanker().rankField;
                        rankCol.getSortParam = function() {return rankField;};
                    }
                },
            
                _enableDragDrop: function() {
                    var _onBeforeDrag = Ext.bind(this._onBeforeDrag, this),
                        onBeforeDrag = function() {
                            if (this.callParent(arguments) === false || _onBeforeDrag.apply(this, arguments) === false) {
                                return false;
                            }
                        };
            
                    this.dragZone = new Rally.ui.grid.dragdrop.DragZone({
                        view: this.view,
                        ddGroup: this.dragGroup || this.ddGroup,
                        dragText: this.dragText,
                        onBeforeDrag: onBeforeDrag
                    });
            
                    this.dropZone = new Rally.ui.grid.dragdrop.DropZone({
                        view: this.view,
                        ddGroup: this.dropGroup || this.ddGroup
                    });
                },
            
                _getRankColumn: function() {
                    var rankCol = this.view.headerCt.items.getAt(0);
                    if (rankCol instanceof Rally.ui.grid.RankColumn) {
                        return rankCol;
                    }
                    return null;
                },
            
                _userDraggingRankCell: function(event) {
                    var rankCol = this._getRankColumn();
                    if (rankCol && event.getTarget('.' + rankCol.tdCls)) {
                        return true;
                    }
                    return false;
                },
            
                _setConstraints: function() {
                    var dragDrop = this.dragZone;
            
                    dragDrop.setInitPosition();
            
                    var el = this.view.getEl(),
                        gridCmp = Ext.ComponentQuery.query('#' + el.up('.rally-grid').id)[0],
                        headerEl = gridCmp.headerCt.getEl(),
                        xy = el.getXY(),
                        top = dragDrop.initPageY - xy[1],
                        padding = 3;
            
                    dragDrop.setXConstraint(0, 0);
                    dragDrop.setYConstraint(top, el.getHeight() - top - headerEl.getHeight() - padding);
                },
            
                _showRankColumn: function() {
                    console.log( this.view.rendered );
                    if (!this.view.hasCls(this.rankEnabledCls)) {
                        this.view.addCls(this.rankEnabledCls);
                    }
                },
            
                _hideRankColumn: function() {
                    this.view.removeCls(this.rankEnabledCls);
                },
            
                _getRanker: function() {
                    if (!this.ranker) {
                        var store = this.view.getStore(),
                            config = {store: store};
            
                        if (store.model.elementName === 'Task') {
                            config.rankField = 'TaskIndex';
                            config.relativeRankPrefix = 'taskIndex';
                        }
                        this.ranker = Ext.create('Rally.data.Ranker', config);
                    }
            
                    return this.ranker;
                },
            
                _onBeforeDrag: function(dragData) {
                    if (!this._userDraggingRankCell(dragData.event)) {
                        return false;
                    }
            
                    this._onInitDrag();
                },
            
                _onInitDrag: function() {
                    if (this.dropZone) {
                        this.dropZone.onInitDrag(this.dragZone);
                    }
            
                    this._setConstraints();
                },
            
                _onStoreLoad: function() {
                    if (this._getRanker().isRankable()) {
                        this.enable();
                    } else {
                        this.disable();
                    }
                },
            
                _onDrop: function(rowEl, dropData, overModel, dropPosition, opts) {
                    var ranker = this._getRanker(),
                        rankConfig = {
                            recordToRank: dropData.records[0],
                            relativeRecord: overModel,
                            position: dropPosition,
                            saveOptions: {
                                callback: this._onRank,
                                scope: this
                            }
                        };
            
                    this.view.ownerCt.setLoading(true);
                    ranker.rankRelative(rankConfig);
                },
            
                _onRank: function(record, operation) {
                    this.view.ownerCt.setLoading(false);
                    this.view.publish(Rally.Message.objectUpdate, record, this.view);
                    Rally.ui.flair.FlairManager.hideAllFlairMessages();
            
                }
            });
            /*global console, Ext */
            var renderUSDate = function(value) {
                var display_value = "";
                if ( value ) {
                    display_value = Rally.util.DateTime.format( value, 'm/d/Y');
                }
                return display_value;
            };
            var renderFieldName = function(value) {
                var display_value = "";
                if ( value ) {
                    display_value = value._refObjectName;
                }
                return display_value;
            };
            var renderRank = function(value, metaData, record, rowIndex, colIndex, store, view) {
                return rowIndex + 1;  
            };
                
            var renderId = function(value, metaData, record, rowIndex, colIndex, store, view) {
                var item = record.getData();
                var url = Rally.util.Navigation.createRallyDetailUrl(item);
                var formatted_string = "<a target='_top' href='/#" + url + "'>" + item.FormattedID + "</a>";
                return formatted_string;  
            };
            
            Ext.define('CustomApp', {
                extend: 'Rally.app.App',
                field_to_sum: 'FeatureEstimate',
                componentCls: 'app',
                items: [
                    { xtype: 'container', itemId: 'grid_box' },      
                    { xtype: 'container',  layout: { type: 'hbox' }, items: [ 
                        { xtype: 'container', margin: 5, itemId: 'date_box' }, 
                        { xtype: 'container', margin: 5, itemId: 'button_box' } 
                    ]}
                ],
                launch: function() {
                    window.console && console.log( "launch" );
                    this._addDatePicker();
                    this._addPrintButton();
                    this._setColumns();
                	this._getPIModel();
                },
                _getBaseURL: function() {
                    var base_url = this.getContext().getWorkspace()._ref.replace(/slm[\w\W]*/,"");
                    return base_url;
                },
                _setColumns: function() {
                    this.columns = [
            	        { xtype: 'rallyrankcolumn', sortable: false },
                        { text: ' ', dataIndex: 'Rank', width: 45, renderer: renderRank, sortable: false },
            	        { text: 'ID', dataIndex: 'FormattedID', width: 50, renderer: renderId, sortable: false },
            	        { text: 'Name', dataIndex: 'Name', editor: 'rallytextfield', flex: 2.5, sortable: false },
            	        { text: 'Running Total', dataIndex: 'RunningTotal', flex: 0.5, sortable: false  },
            	        { text: 'Feature Estimate', dataIndex: 'FeatureEstimate', editor: 'rallynumberfield', flex: 0.5, sortable: false },
            	        { text: 'Planned Start', dataIndex: 'PlannedStartDate', editor: 'rallydatefield', renderer: renderUSDate, flex: 0.75, sortable: false },
            	        { text: 'Planned End', dataIndex: 'PlannedEndDate', editor: 'rallydatefield', renderer: renderUSDate, flex: 0.75, sortable: false },
            	        { text: 'State', dataIndex: 'State', editor: this._getStateEditor(), renderer: renderFieldName, flex: 1.25, sortable: false },
            	        { text: 'Owner', dataIndex: 'Owner', renderer: renderFieldName, flex: 0.75, sortable: false },
            	        { text: 'Parent', dataIndex: 'Parent', renderer: renderFieldName, flex: 2, sortable: false }
            	    ];
                },
                _addDatePicker: function() {
                    window.console && console.log( "_addDatePicker" );
                    this.date_picker = Ext.create( 'Rally.ui.DateField',{
                        fieldLabel: 'Planned Items After ',
                        labelWidth: 125,
                        value: Rally.util.DateTime.add( new Date(), "month", -1 ),
                        listeners: {
                            change: function( field, newValue, oldValue, eOpts ) {
                                this._getData();
                            },
                            scope: this
                        }
                    } );
                    this.down("#date_box").add(this.date_picker);
                },
                _addPrintButton: function() {
                    window.console && console.log( "_addPrintButton" );
                    this.down('#button_box').add(Ext.create('Rally.ui.Button', { 
                        text: 'Print',
                        listeners: {
                            click: {
                                fn: function() { this._print('grid_box'); },
                                scope: this
                            }
                        }
                    }));
                    
                },
                _getStateEditor: function() {
                    var editor = {
                        xtype: 'rallycombobox',
                        displayField: 'Name',
                        valueField: '_ref',
                        storeConfig: {
            		        autoLoad: true,
            		        model: 'State',
                            filters: [{ property: 'TypeDef.Name', operator: 'contains', value: 'Feature' }]
            		    }
                    };
                    return editor;
                },
                _getPIModel: function() {
                	Rally.data.ModelFactory.getModel({
                		type: 'PortfolioItem/Feature',
                		success: function(our_model) {
                			this.model = our_model;
                			this._getData();
                		},
                		scope: this
                	});
                },
                _getFilters: function() {
                    var filters = [ { property: 'ObjectID', operator: '>', value: '0' }];
                    if ( this.date_picker.getValue() ) {
                        var iso_value = Rally.util.DateTime.toIsoString( this.date_picker.getValue() );
                        filters = Ext.create('Rally.data.QueryFilter',
                            { property: 'PlannedEndDate', operator: '=', value: "null" }).or( Ext.create( 'Rally.data.QueryFilter',
                            { property: 'PlannedEndDate', operator: '>', value: iso_value }));
                        window.console && console.log( filters.toString() );
                        
                    }
                    return filters;
                },
                _getFetchFields: function() {
                    var fields = [];
                    Ext.Array.each( this.columns, function( col ) {
                    	if ( col && col.dataIndex ) {
                    		fields.push( col.dataIndex );
                    	}
                    });
                    return fields;
                },
                _getData: function() {
                	var that = this;
                    window.console && console.log( this.date_picker.getValue() );
                	this.pi_store = Ext.create('Rally.data.WsapiDataStore', {
                		autoLoad: true,
                		model: that.model,
                        filters: that._getFilters(),
                        sorters: [ { property: 'Rank', direction: 'ASC' } ],
                		listeners: {
                			load: function(store,data,success) {
                                window.console && console.log( "load" );
                                var records = store.getRecords();
                                var running_total = 0;
                                for ( var i=0; i<records.length; i++ ) {
                                    var record = records[i];
                                    var value = record.data[this.field_to_sum] || 0;
                                    running_total += value;
                                    record.data.RunningTotal = running_total;
                                }
                                
                				this._addPIGrid();
                			},
                            datachanged: function( store, opts ) {
                                window.console && console.log( "datachanged" );
                                var records = store.getRecords();
                                var running_total = 0;
                                for ( var i=0; i<records.length; i++ ) {
                                    var record = records[i];
                                    var value = record.data[this.field_to_sum] || 0;
                                    running_total += value;
                                    record.set( "RunningTotal", running_total);
                                }
                            },
                			scope: this
                		},
                		fetch: that._getFetchFields()
                	});    
            	},
                _addPIGrid: function() {
                    window.console && console.log( "_addPIGrid" );
                	if ( this.model ) {
                        if ( this.pi_grid ) { 
                            window.console && console.log( "Already has a pi_grid" );
                            this.pi_grid.destroy();
                        } 
                		this.pi_grid = Ext.create( 'Rally.ui.grid.Grid', {
                			/*model: this.model,*/
                			height: 475,
                            
                			/*enableRanking: true,*/
                			viewConfig: {
                				plugins: [
                					{ ptype: 'rallydragdrop2' }
                				]
                			},
            	    		columnCfgs: this.columns,
            	    		store: this.pi_store
                		});
                	    this.down('#grid_box').add(this.pi_grid);
                        
                	}
                },
                _print: function() {
                    var that = this;
                    
                    var cols = [
                        { text: 'ID', dataIndex: 'FormattedID', width: 50 },
                        { text: 'Name', dataIndex: 'Name', editor: 'rallytextfield', flex: 2 },
                        { text: 'Running Total', dataIndex: 'RunningTotal' },
                        { text: 'Feature Estimate', dataIndex: 'FeatureEstimate', editor: 'rallynumberfield' },
                        { text: 'Planned Start', dataIndex: 'PlannedStartDate', editor: 'rallydatefield', renderer: renderUSDate },
                        { text: 'Planned End', dataIndex: 'PlannedEndDate', editor: 'rallydatefield', renderer: renderUSDate },
                        { text: 'State', dataIndex: 'State', editor: this._getStateEditor(), renderer: renderFieldName },
                        { text: 'Owner', dataIndex: 'Owner', renderer: renderFieldName },
                        { text: 'Parent', dataIndex: 'Parent', renderer: renderFieldName }
                    ];
                    var hidden_window = Ext.create( 'Ext.window.Window', {
                        title: '',
                        width: 1048,
                        height: 200,
                        overflowX: 'hidden',
                        layout: 'fit',
                        items: [ { xtype: 'container', itemId: 'grid_box' } ]
                    }).show();
                    
                    print_store = Ext.create('Rally.data.WsapiDataStore', {
                        autoLoad: true,
                        model: that.model,
                        filters: that._getFilters(),
                        sorters: [ { property: 'Rank', direction: 'ASC' } ],
                        listeners: {
                            load: function(store,data,success) {
                                window.console && console.log( "load" );
                                var records = store.getRecords();
                                var running_total = 0;
                                for ( var i=0; i<records.length; i++ ) {
                                    var record = records[i];
                                    var value = record.data[this.field_to_sum] || 0;
                                    running_total += value;
                                    record.data.RunningTotal = running_total;
                                }
                                var hidden_grid = Ext.create( 'Rally.ui.grid.Grid', {
            			            model: this.model,
            			            // columnCfgs: this.columns.slice(1,this.columns.length),
                                    columnCfgs: cols,
            			            store: print_store,
                                    overflowX: 'hidden',
                                    margin: 5,
                                    layout: 'fit',
            			            showPagingToolbar: false,
            			            listeners: {
            			                viewready: function( grid, options ) {
                                            window.console && console.log( "print grid view_ready" );
            			                    var print_window = window.open('','', 'width=800,height=200');
            			                    print_window.focus();
            			                    print_window.document.write( '<html><head>');
            			                    print_window.document.write('<title>Feature Print</title>');
            			                    print_window.document.write('<link rel="Stylesheet" type="text/css" href="' + that._getBaseURL() + 'apps/2.0p5/rui/resources/css/rui.css" />');
            			                    print_window.document.write('</head>');
            			                    print_window.document.write('<body>');
            			                    print_window.document.write( hidden_grid.getEl().getHTML() );
            			                    print_window.document.write('</body>');
            			                    print_window.document.write('</html>'); 
            			                    
            			                    hidden_window.hide();
            			                    print_window.print();
                                            print_window.close();
            			                }
            			            }
            			        });
                                hidden_window.down('#grid_box').add( hidden_grid );
                            },
                            scope: this
                        },
                        fetch: that._getFetchFields()
                    });  
                },
                _printOld: function( element_name ) {
                    var printElement = this.down('#'+element_name);
                    var printWindow = window.open('','', 'width=400,height=200');
                    printWindow.document.write( '<html><head>');
                    printWindow.document.write('<title>Feature Print</title>');
                    printWindow.document.write('<link rel="Stylesheet" type="text/css" href="' + this._getBaseURL() + 'apps/2.0p5/rui/resources/css/rui.css" />');
                    
                    printWindow.document.write('</head><body>');
                    printWindow.document.write(printElement.el.dom.innerHTML);
                    printWindow.document.write('</body></html>');
                    printWindow.print();
                }
            });

            Rally.launchApp('CustomApp', {
                name: 'RunningTotal'
            });
        });
    </script>

    <style type="text/css">
        .app {
             /* Add app styles here */
        }
        
        .rally-edit-cell-over {
        	background-image: url('/slm/js/rally/resources/images/editIcon.png');
        	background-position: right 2px;
        	background-repeat: no-repeat;
        }    </style>
</head>
<body></body>
</html>
